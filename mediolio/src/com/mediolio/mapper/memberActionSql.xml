<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="ma">

    <insert id="projectLike" parameterType="mavo">
		INSERT INTO member_action (act_type, act_to, act_from, p_id, act_date, act_read) VALUES ('like', #{act_to}, #{act_from},#{p_id}, now(), 0)
	</insert>
	
	<delete id="projectLikeCancel" parameterType="mavo">
		DELETE FROM member_action WHERE act_type='like' AND act_from=#{act_from} AND p_id=#{p_id}
	</delete>
		
  	<select id="getProjectLike" parameterType="int" resultType="int">
		SELECT count(*) from member_action WHERE act_type='like' AND p_id=#{p_id}
	</select>
	
  	<insert id="msgSend" parameterType="msvo">
		INSERT INTO message (msg_from, msg_to, msg_text, msg_date, msg_from_status, msg_to_status) VALUES (#{msg_from}, #{msg_to}, #{msg_text}, now(), 'sent', 'no-read')
	</insert>
	
	<select id="getMsgListReceived" parameterType="int" resultType="pmvo">
		SELECT msg.msg_id, msg.msg_from, msg.msg_text, DATE_FORMAT(msg.msg_date, '%Y.%m.%d %H:%i:%s') AS msg_date, 
			msg.msg_to_status, m.m_studentID AS msg_from_studentID, m.m_name AS msg_from_nickname
			FROM message msg, member m 
				WHERE msg.msg_from=m.m_id AND msg.msg_to=#{m_id} AND msg.msg_to_status != 'deleted' ORDER BY msg.msg_to_status ASC, msg.msg_id DESC
	</select>
	
	<select id="getMsgListSent" parameterType="int" resultType="pmvo">
		SELECT msg.msg_id, msg.msg_to, msg.msg_text, DATE_FORMAT(msg.msg_date, '%Y.%m.%d %H:%i:%s') AS msg_date, 
			m.m_studentID AS msg_to_studentID, m.m_name AS msg_to_nickname
			FROM message msg, member m 
				WHERE msg.msg_to=m.m_id AND msg.msg_from=#{m_id} AND msg.msg_from_status = 'sent' ORDER BY msg.msg_id DESC
	</select>
	
	<update id="deleteMsgSent" parameterType="int">
		UPDATE message SET msg_from_status = 'deleted' WHERE msg_id = #{msg_id}
	</update>
	
	<update id="deleteMsgReceived" parameterType="int">
		UPDATE message SET msg_to_status = 'deleted' WHERE msg_id = #{msg_id}
	</update>
	
	<update id="readMsgReceived" parameterType ="int">
		UPDATE message SET msg_to_status='read' WHERE msg_id = #{msg_id}
	</update>
	
	<insert id="followMember" parameterType="mavo">
		INSERT INTO member_action (act_type, act_to, act_from, act_date, act_read) VALUES ('follow', #{act_to}, #{act_from}, now(), 0)
	</insert>
	
	<delete id="followCancel" parameterType="mavo">
		DELETE FROM member_action WHERE act_type='follow' AND act_from=#{act_from} AND act_to=#{act_to}
	</delete>
	
	<select id="followCheck" parameterType = "mavo" resultType="int">
		SELECT count(*) from member_action WHERE act_type='follow' AND act_from=#{act_from} AND act_to=#{act_to}
	</select>

	<select id="getFollowingList" parameterType="int" resultType="fvo">
		SELECT m.m_id, CONCAT_WS(' ', m.m_studentID, m.m_name) AS m_nickname, m.m_introduce, m.m_interestingPart, 
			SUBSTRING_INDEX(m_interestingPart,',',1) AS m_interestingId1, 
			SUBSTRING_INDEX(SUBSTRING_INDEX(m_interestingPart,',',2),',',-1) AS m_interestingId2, 
			SUBSTRING_INDEX(SUBSTRING_INDEX(m_interestingPart,',',3),',',-1) AS m_interestingId3,
			(SELECT CONCAT_WS(' ', c.cate_name,sc.sc_name) FROM category c, subcategory sc WHERE c.cate_id=sc.sc_parent AND sc.sc_id=m_interestingId1) AS m_interestingText1,
			(SELECT CONCAT_WS(' ', c.cate_name,sc.sc_name) FROM category c, subcategory sc WHERE c.cate_id=sc.sc_parent AND sc.sc_id=m_interestingId2) AS m_interestingText2,
			(SELECT CONCAT_WS(' ', c.cate_name,sc.sc_name) FROM category c, subcategory sc WHERE c.cate_id=sc.sc_parent AND sc.sc_id=m_interestingId3) AS m_interestingText3,
			(SELECT SUBSTRING_INDEX(GROUP_CONCAT(CONCAT_WS(',', p_id, p_coverImg) SEPARATOR '/'), ',', 3) FROM project WHERE m_id=m.m_id ORDER BY p_viewnum DESC) AS projects
				FROM member m, member_action ma WHERE m.m_id=ma.act_to AND ma.act_type='follow' AND ma.act_from=#{m_id}
	</select>
	
	<select id="getFollowerList" parameterType="int" resultType="fvo">
		SELECT m.m_id, CONCAT_WS(' ', m.m_studentID, m.m_name) AS m_nickname, m.m_introduce, m.m_interestingPart, 
			SUBSTRING_INDEX(m_interestingPart,',',1) AS m_interestingId1, 
			SUBSTRING_INDEX(SUBSTRING_INDEX(m_interestingPart,',',2),',',-1) AS m_interestingId2, 
			SUBSTRING_INDEX(SUBSTRING_INDEX(m_interestingPart,',',3),',',-1) AS m_interestingId3,
			(SELECT CONCAT_WS(' ', c.cate_name,sc.sc_name) FROM category c, subcategory sc WHERE c.cate_id=sc.sc_parent AND sc.sc_id=m_interestingId1) AS m_interestingText1,
			(SELECT CONCAT_WS(' ', c.cate_name,sc.sc_name) FROM category c, subcategory sc WHERE c.cate_id=sc.sc_parent AND sc.sc_id=m_interestingId2) AS m_interestingText2,
			(SELECT CONCAT_WS(' ', c.cate_name,sc.sc_name) FROM category c, subcategory sc WHERE c.cate_id=sc.sc_parent AND sc.sc_id=m_interestingId3) AS m_interestingText3,
			(SELECT SUBSTRING_INDEX(GROUP_CONCAT(CONCAT_WS(',', p_id, p_coverImg) SEPARATOR '/'), ',', 3) FROM project WHERE m_id=m.m_id ORDER BY p_viewnum DESC) AS projects
				FROM member m, member_action ma WHERE m.m_id=ma.act_from AND ma.act_type='follow' AND ma.act_to=#{m_id}
	</select>
	
  	<select id="friendCnt" parameterType="int" resultType="java.util.HashMap">
  		SELECT
			(SELECT count(*) from member_action WHERE act_type = 'follow' AND act_from = #{m_id } ) AS following,
			(SELECT count(*) from member_action WHERE act_type = 'follow' AND act_to = #{m_id } ) AS follower
		FROM dual 	
  	</select>
  </mapper>
  
